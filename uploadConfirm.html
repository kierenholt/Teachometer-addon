<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    
  </head>
  <body onload="onLoad()">
  
  <div id="enterNameTopicDiv">
    <h2>Enter the title of the lesson (e.g. Conservation of energy) or the date</h2> 
    
    <p>Title: <input type=text id="titleInput"  value="" /> <button id="uploadButton" onclick="uploadToSite()" >UPLOAD</button> 
    <img id="loadingGif" src="https://i.imgur.com/ErfEUeJ.gif" style="height:32px;display:none"/>
    </p>
    
    <p id="uploadToSiteErrorMessage" style="color:red"></p> 
    <p> <input type="checkbox" id="isTestModeCheckBox"/>Check to enable exam mode. this will shuffle the questions and apply a check limit of 1 </p>
    
  </div>
  
  
  <div id="uploadSuccess" hidden>
    <h1>Success!</h1>
    <p>
    The marksheet for your new lesson is <a id="uploadedMarksheetLink" href="" target="_blank">here</a>
    <br><br>
    The lesson page is <a id="lessonUrlLink" href="" target="_blank">here</a>
    <input type="text" value="" id="lessonUrlInput" style="width:1px; border: none"/>&nbsp;<button onclick="copyText('lessonUrlInput')">Copy Lesson Link</button> 
    <br><br>
    The course page is <a id="courseUrlLink" href="" target="_blank">here</a> 
    <input type="text" value="" id="courseUrlInput" style="width:1px; border: none"/>&nbsp;<button onclick="copyText('courseUrlInput')">Copy Course Link</button> 
    </p>
  </div>
      
      
  <p> 
  
  <p id="noStudentsErrorMessage" style="color:red" hidden>ACTION REQUIRED: Please add students before your upload</p>
  <br>
  <h2>Add Students</h2><button onclick="toggleStudents()" >Show</button>
  
  <div id="Students" hidden>
    <?!= includeTemplate('students'); ?>
  </div>
      
  <script>


function onLoad() {
  var d = new Date();
  var options = {month: "long", day: "numeric", weekday: "long"};
  document.getElementById("titleInput").value = d.toLocaleDateString("en-GB",options);
  
  //check if no student
  if (document.getElementById("studentNamesTextarea").value == "") {
    document.getElementById("noStudentsErrorMessage").hidden = false;
  }
}
    
function toggleStudents() {
  document.getElementById("Students").hidden = !(document.getElementById("Students").hidden);
}


function uploadToSite() {
  
  if (document.getElementById("studentNamesTextarea").value == "") {
    document.getElementById("noStudentsErrorMessage").hidden = false;
    return;
  }

  var uploadDataString = <?=uploadDataString?>; //NO QUOTES!!
  //alert("settingsString: "+settingsString);
  var uploadDataObject = JSON.parse(uploadDataString);
    //alert(JSON.stringify(uploadDataObject));
  
  if (document.getElementById("titleInput").value) {
  
    uploadDataObject["name"] = document.getElementById("titleInput").value; //name
    uploadDataObject["isTestMode"] = document.getElementById("isTestModeCheckBox").checked; //isTestMode
    document.getElementById("loadingGif").style.display = "inline";
        
    google.script.run
          .withSuccessHandler(
            function(ret, element) { //returns  [page.getUrl(),pageName,pageAlreadyExists];
                if (ret != null) {
                  document.getElementById("uploadToSiteErrorMessage").innerHTML = "";
                  document.getElementById("loadingGif").style.display = "none";
                  
                  
                  document.getElementById("uploadSuccess").hidden = false;
                  document.getElementById("uploadedMarksheetLink").href = ret["marksheetUrl"];
                  
                  document.getElementById("lessonUrlLink").href = ret["lessonUrl"];
                  document.getElementById("lessonUrlInput").value = ret["lessonUrl"];
                  
                  document.getElementById("courseUrlLink").href = ret["courseUrl"];
                  document.getElementById("courseUrlInput").value = ret["courseUrl"];
                  
                }
              }
            ).withFailureHandler(
            function(error) { 
                document.getElementById("uploadToSiteErrorMessage").innerHTML = error;
                  document.getElementById("loadingGif").style.display = "none";           
                  }
            ).upload(
              uploadDataObject
            );
    } //end of if
}


function copyText(id) {
  var copyText = document.getElementById(id);
  copyText.select();
  copyText.setSelectionRange(0, 99999);
  document.execCommand("copy");
}

  </script>
      
  </body>
</html>


